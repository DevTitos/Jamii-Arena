 {% extends 'base.html' %}
 {% block title %}NFT Marketplace{% endblock title %}
 {% block style %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tech-border {
            border: 1px solid rgba(0, 240, 214, 0.3);
            box-shadow: 0 0 15px rgba(0, 240, 214, 0.1);
        }
        
        .card-glass {
            background: rgba(7, 16, 38, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }
        
        .accent-text {
            color: var(--accent);
        }
        
        .accent-gradient {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 240, 214, 0.4);
        }
        
        .btn-secondary {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(0, 240, 214, 0.1);
            transform: translateY(-2px);
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 240, 214, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(0, 240, 214, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 240, 214, 0); }
        }
        
        .glitch {
            position: relative;
            animation: glitch 5s infinite;
        }
        
        @keyframes glitch {
            0% { text-shadow: 0 0 0 var(--accent); }
            5% { text-shadow: -2px 2px 0 #ff00ff, 2px -2px 0 #00ffff; }
            6% { text-shadow: 0 0 0 var(--accent); }
            100% { text-shadow: 0 0 0 var(--accent); }
        }
        
        .hex-pattern {
            background-image: 
                linear-gradient(to right, rgba(0, 240, 214, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 240, 214, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .nft-card {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 240, 214, 0.2);
        }
        
        .nft-image {
            transition: all 0.5s ease;
        }
        
        .nft-card:hover .nft-image {
            transform: scale(1.05);
        }
        
        .tab-button {
            transition: all 0.3s ease;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .tab-button.active {
            background: rgba(0, 240, 214, 0.2);
            border-bottom: 2px solid var(--accent);
        }
        
        .filter-pill {
            transition: all 0.3s ease;
            padding: 6px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .filter-pill.active {
            background: var(--accent);
            color: #000;
        }
        
        .filter-pill:hover {
            background: rgba(0, 240, 214, 0.3);
        }
        
        .rarity-common {
            border-left: 3px solid #9fb4c9;
        }
        
        .rarity-rare {
            border-left: 3px solid #00f0d6;
        }
        
        .rarity-epic {
            border-left: 3px solid #cc00ff;
        }
        
        .rarity-legendary {
            border-left: 3px solid #ff9900;
        }
    </style>
    <style>
.competition-card {
    transition: all 0.3s ease;
}

.competition-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 240, 214, 0.2);
}

.nft-card {
    transition: all 0.3s ease;
}

.nft-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 240, 214, 0.2);
}
</style>
{% endblock style %}
{% block content %}
        <div class="text-center mb-10 fade-in">
            <h1 class="text-4xl md:text-5xl font-bold glitch accent-text">NFT Marketplace</h1>
            <p class="text-[#9fb4c9] mt-3 max-w-2xl mx-auto">Discover exclusive NFT tickets, vote for your favorite artists, and manage your collection</p>
        </div>

        <!-- Tabs -->
        <div class="flex justify-center mb-8">
            <div class="card-glass p-1 flex">
                <div class="tab-button active" id="marketplace-tab">
                    <i class="fas fa-store mr-2"></i> Marketplace
                </div>
                <div class="tab-button" id="my-tickets-tab">
                    <i class="fas fa-ticket-alt mr-2"></i> My Tickets
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card-glass p-5 mb-8 fade-in">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h3 class="text-lg font-bold">Filters</h3>
                
                <div class="flex flex-wrap gap-2">
                    <div class="filter-pill active">All</div>
                    <div class="filter-pill">Ticket Passes</div>
                </div>
                
                <div class="relative">
                    <input type="text" placeholder="Search NFTs..." class="form-input w-full md:w-64 px-4 py-2 rounded-lg bg-[#071026] border border-[#00f0d6]/30 text-sm">
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-[#9fb4c9]"></i>
                </div>
            </div>
        </div>

        <!-- Marketplace Section -->
        <div id="marketplace-section" class="fade-in">


<!-- Available Competitions Grid -->
<h2 class="text-2xl font-bold mb-6">Extreme Experience Passes</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for competition in competitions %}
    <div class="competition-card card-glass rounded-xl overflow-hidden">
        <div class="h-48 bg-gradient-to-br {{ competition.get_gradient }} relative overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas {{ competition.get_icon }} text-white text-5xl"></i>
            </div>
            <!-- Display competition info on each card -->
            <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                {{ competition.get_status_display }}
            </div>
            <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                <i class="fas fa-users mr-1"></i> {{ competition.contestant_set.count }}
            </div>
            <div class="absolute bottom-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                {{ competition.get_tickets_sold }}/{{ competition.get_max_tickets }}
            </div>
        </div>
        <div class="p-4">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold">{{ competition.title }}</h4>
                    <p class="text-xs text-[#9fb4c9] mt-1">{{ competition.venue }}</p>
                    <p class="text-xs text-[#9fb4c9]">{{ competition.date_time|date:"M d, Y â€¢ g:i A" }}</p>
                </div>
                <div class="text-xs bg-[#071026] px-2 py-1 rounded">
                    {{ competition.get_category_display }}
                </div>
            </div>
            
            <div class="mt-3 space-y-2">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-[#9fb4c9]">Prize Pool</span>
                    <span class="font-bold accent-text">${{ competition.prize_pool }} HTS</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-[#9fb4c9]">Contestants</span>
                    <span class="font-bold">{{ competition.contestant_set.count }} registered</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-[#9fb4c9]">Registration Fee</span>
                    <span class="font-bold accent-text">${{ competition.registration_fee }} HTS</span>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <div>
                    <p class="text-xs text-[#9fb4c9]">Pass Price</p>
                    <p class="font-bold accent-text">{{ competition.get_ticket_price }} HBAR</p>
                </div>
                <div class="flex gap-2">
                    <button class="btn-secondary px-2 py-1 rounded-lg text-xs"
                            onclick="showCompetitionDetails({{ competition.id }})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn-primary px-3 py-1 rounded-lg text-sm buy-ticket"
                            data-competition-id="{{ competition.id }}"
                            data-competition-title="{{ competition.title }}"
                            {% if competition.is_sold_out %}disabled{% endif %}>
                        {% if competition.is_sold_out %}Sold Out
                        {% else %}Buy Pass
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
        <p class="text-[#9fb4c9]">No competitions available at the moment.</p>
    </div>
    {% endfor %}
</div>
 
<br>

<!-- Alternative: Show NFT Passes instead of Competitions -->
<h2 class="text-2xl font-bold mb-6">Available Experience Passes</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
    {% for nft in available_nfts %}
    <div class="nft-card card-glass rounded-xl overflow-hidden">
        <div class="h-48 bg-gradient-to-br {{ nft.collection.get_gradient }} relative overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center">
                <i class="fas {{ nft.collection.get_icon }} text-white text-5xl"></i>
            </div>
            <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                #{{ nft.serial_number }}/{{ nft.collection.max_supply }}
            </div>
            <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                <i class="fas fa-vote-yea mr-1"></i> {{ nft.collection.get_votes }}
            </div>
            <div class="absolute bottom-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                {{ nft.collection.competition.get_category_display }}
            </div>
        </div>
        <div class="p-4">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold">{{ nft.collection.competition.title }}</h4>
                    <p class="text-xs text-[#9fb4c9] mt-1">{{ nft.collection.get_title }}</p>
                    <p class="text-xs text-[#9fb4c9]">{{ nft.collection.competition.date_time|date:"M d, Y" }}</p>
                </div>
                <div class="text-xs bg-[#071026] px-2 py-1 rounded">
                    {{ nft.collection.get_rarity_display }}
                </div>
            </div>
            
            <div class="mt-3 space-y-2">
                <div class="flex justify-between items-center text-xs">
                    <span class="text-[#9fb4c9]">Voting Power</span>
                    <span class="font-bold">{{ nft.collection.get_votes }} votes</span>
                </div>
                <div class="flex justify-between items-center text-xs">
                    <span class="text-[#9fb4c9]">Competition</span>
                    <span class="font-bold">{{ nft.collection.competition.get_category_display }}</span>
                </div>
            </div>
            
            <div class="flex justify-between items-center mt-4">
                <div>
                    <p class="text-xs text-[#9fb4c9]">Price</p>
                    <p class="font-bold accent-text">{{ nft.price }} HBAR</p>
                </div>
                <button class="btn-primary px-3 py-1 rounded-lg text-sm buy-nft"
                        data-nft-id="{{ nft.id }}"
                        data-competition-id="{{ nft.collection.competition.id }}"
                        {% if not nft.is_available %}disabled{% endif %}>
                    {% if not nft.is_available %}Sold Out
                    {% else %}Buy Now
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-span-full text-center py-12">
        <p class="text-[#9fb4c9]">No passes available for purchase.</p>
    </div>
    {% endfor %}
</div>


<!--
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">

            </div>
            
            <div class="text-center mt-10">
                <button class="btn-secondary px-6 py-3 rounded-lg">
                    <i class="fas fa-redo mr-2"></i> Load More NFTs
                </button>
            </div>
        </div>
-->

        <!-- My Tickets Section -->
        <div id="my-tickets-section" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">My NFT Tickets</h2>
                <div class="text-sm text-[#9fb4c9]">12 NFTs in collection</div>
            </div>
            
            <!-- Collection Stats -->
            <div class="card-glass p-5 mb-8">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-2xl font-bold accent-text">12</div>
                        <div class="text-sm text-[#9fb4c9]">Total Tickets</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold accent-text">42</div>
                        <div class="text-sm text-[#9fb4c9]">Voting Power</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold accent-text">3</div>
                        <div class="text-sm text-[#9fb4c9]">Rare Tickets</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold accent-text">1</div>
                        <div class="text-sm text-[#9fb4c9]">Legendary</div>
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Owned NFT Card -->
                <div class="nft-card card-glass rounded-xl overflow-hidden rarity-rare">
                                    <div class="h-48 bg-gradient-to-br from-[#00f0d6] to-[#007a6c] relative overflow-hidden">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <i class="fas fa-ticket-alt text-white text-5xl"></i>
                                        </div>
                                        <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            Rare
                                        </div>
                                        <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            <i class="fas fa-vote-yea mr-1"></i> 5 Votes
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-semibold">Golden Access Pass</h4>
                                                <p class="text-xs text-[#9fb4c9] mt-1">Season 2 â€¢ VIP Ticket</p>
                                            </div>
                                            <div class="text-xs bg-[#071026] px-2 py-1 rounded">#042</div>
                                        </div>
                                        <div class="flex justify-between items-center mt-4">
                                            <div>
                                                <p class="text-xs text-[#9fb4c9]">Owned</p>
                                                <p class="text-xs accent-text">3 days ago</p>
                                            </div>
                                            <button class="btn-secondary px-3 py-1 rounded-lg text-sm">
                                                Use Votes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                
                <!-- Owned NFT Card -->
                <div class="nft-card card-glass rounded-xl overflow-hidden rarity-common">
                                    <div class="h-48 bg-gradient-to-br from-[#0052cc] to-[#00f0d6] relative overflow-hidden">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <i class="fas fa-music text-white text-5xl"></i>
                                        </div>
                                        <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            Common
                                        </div>
                                        <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            <i class="fas fa-vote-yea mr-1"></i> 1 Vote
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-semibold">General Admission</h4>
                                                <p class="text-xs text-[#9fb4c9] mt-1">Season 2 â€¢ Standard</p>
                                            </div>
                                            <div class="text-xs bg-[#071026] px-2 py-1 rounded">#103</div>
                                        </div>
                                        <div class="flex justify-between items-center mt-4">
                                            <div>
                                                <p class="text-xs text-[#9fb4c9]">Owned</p>
                                                <p class="text-xs accent-text">1 week ago</p>
                                            </div>
                                            <button class="btn-secondary px-3 py-1 rounded-lg text-sm">
                                                Use Votes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                
                <!-- Owned NFT Card -->
                <div class="nft-card card-glass rounded-xl overflow-hidden rarity-legendary">
                                    <div class="h-48 bg-gradient-to-br from-[#ff9900] to-[#00f0d6] relative overflow-hidden">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <i class="fas fa-gem text-white text-5xl"></i>
                                        </div>
                                        <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            Legendary
                                        </div>
                                        <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            <i class="fas fa-vote-yea mr-1"></i> 20 Votes
                                        </div>
                                        <div class="absolute bottom-3 left-3 bg-[#cc00ff] px-2 py-1 rounded-lg text-xs">
                                            <i class="fas fa-award mr-1"></i> Special
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-semibold">Backstage Experience</h4>
                                                <p class="text-xs text-[#9fb4c9] mt-1">Season 2 â€¢ Exclusive</p>
                                            </div>
                                            <div class="text-xs bg-[#071026] px-2 py-1 rounded">#005</div>
                                        </div>
                                        <div class="flex justify-between items-center mt-4">
                                            <div>
                                                <p class="text-xs text-[#9fb4c9]">Owned</p>
                                                <p class="text-xs accent-text">2 days ago</p>
                                            </div>
                                            <button class="btn-secondary px-3 py-1 rounded-lg text-sm">
                                                Use Votes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                
                <!-- Owned NFT Card -->
                <div class="nft-card card-glass rounded-xl overflow-hidden rarity-common">
                                    <div class="h-48 bg-gradient-to-br from-[#0052cc] to-[#00f0d6] relative overflow-hidden">
                                        <div class="absolute inset-0 flex items-center justify-center">
                                            <i class="fas fa-music text-white text-5xl"></i>
                                        </div>
                                        <div class="absolute top-3 right-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            Common
                                        </div>
                                        <div class="absolute top-3 left-3 bg-[#071026] px-2 py-1 rounded-lg text-xs">
                                            <i class="fas fa-vote-yea mr-1"></i> 1 Vote
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="font-semibold">General Admission</h4>
                                                <p class="text-xs text-[#9fb4c9] mt-1">Season 1 â€¢ Standard</p>
                                            </div>
                                            <div class="text-xs bg-[#071026] px-2 py-1 rounded">#087</div>
                                        </div>
                                        <div class="flex justify-between items-center mt-4">
                                            <div>
                                                <p class="text-xs text-[#9fb4c9]">Owned</p>
                                                <p class="text-xs accent-text">1 month ago</p>
                                            </div>
                                            <button class="btn-secondary px-3 py-1 rounded-lg text-sm">
                                                Use Votes
                                            </button>
                                        </div>
                                    </div>
                                </div>
            </div>
            
            <div class="card-glass p-5 mt-8">
                <h3 class="text-lg font-bold mb-4">Voting Power Summary</h3>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-[#9fb4c9]">Available Votes</span>
                        <span class="font-bold accent-text">42</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[#9fb4c9]">Votes Used This Season</span>
                        <span class="font-bold">18</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[#9fb4c9]">Votes Remaining</span>
                        <span class="font-bold">24</span>
                    </div>
                    <div class="mt-4">
                        <div class="progress-bar bg-[#071026] h-3 rounded-full">
                            <div class="progress-fill h-3 rounded-full" style="width: 43%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-[#9fb4c9] mt-1">
                            <span>18 used</span>
                            <span>24 available</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    <script>
        // Tab switching functionality
        document.getElementById('marketplace-tab').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('my-tickets-tab').classList.remove('active');
            document.getElementById('marketplace-section').classList.remove('hidden');
            document.getElementById('my-tickets-section').classList.add('hidden');
        });
        
        document.getElementById('my-tickets-tab').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('marketplace-tab').classList.remove('active');
            document.getElementById('my-tickets-section').classList.remove('hidden');
            document.getElementById('marketplace-section').classList.add('hidden');
        });
        
        // Filter pill functionality
        document.querySelectorAll('.filter-pill').forEach(pill => {
            pill.addEventListener('click', function() {
                document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Animate elements on scroll
        const observerOptions = {
            root: null,
            rootMargin: '0px',
            threshold: 0.1
        };
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('fade-in');
                }
            });
        }, observerOptions);
        
        document.querySelectorAll('.fade-in').forEach(element => {
            observer.observe(element);
        });
        
        // Simulate loading of more NFTs
        document.querySelector('.btn-secondary').addEventListener('click', function() {
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Loading...';
            setTimeout(() => {
                this.innerHTML = '<i class="fas fa-redo mr-2"></i> Load More NFTs';
                alert('More NFTs would be loaded here...');
            }, 1500);
        });
    </script>


<script>
// Buy NFT Function
async function buyNFT(nftType, serialNumber) {
    console.log(`Attempting to buy ${nftType} #${serialNumber}`);
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Processing...';
    button.disabled = true;
    
    try {
        // 1. Get user's Hedera wallet address (you need to implement this)
        const userWallet = await getCurrentUserWallet();
        if (!userWallet) {
            alert('Please connect your wallet first!');
            return;
        }
        
        // 2. Check if NFT is still available
        const response = await fetch(`/arena/api/check-nft-availability/${nftType}/${serialNumber}/`);
        const data = await response.json();
        
        if (!data.available) {
            alert('Sorry, this NFT is no longer available!');
            return;
        }
        
        // 3. Process payment (Hedera transaction)
        const transactionResult = await processHederaPayment(
            userWallet, 
            nftType, 
            serialNumber, 
            data.price
        );
        
        if (transactionResult.success) {
            // 4. Transfer NFT to user
            const transferResult = await transferNFTToUser(
                nftType,
                serialNumber,
                userWallet,
                transactionResult.transactionHash
            );
            
            if (transferResult.success) {
                alert('ðŸŽ‰ Purchase successful! NFT transferred to your wallet.');
                // Refresh the page or update UI
                window.location.reload();
            } else {
                throw new Error('NFT transfer failed');
            }
            
        } else {
            throw new Error('Payment failed');
        }
        
    } catch (error) {
        console.error('Purchase error:', error);
        alert('Purchase failed: ' + error.message);
    } finally {
        // Reset button state
        button.textContent = originalText;
        button.disabled = false;
    }
}

// Mock functions - you need to implement these based on your setup
async function getCurrentUserWallet() {
    // Implement wallet connection logic
    // Example: return window.hederaWallet.getAccountId();
    return "0.0.123456"; // Mock wallet for testing
}

async function processHederaPayment(wallet, nftType, serialNumber, price) {
    // Implement Hedera payment logic
    console.log(`Processing payment of ${price} HBAR from ${wallet} for ${nftType}#${serialNumber}`);
    
    // This should actually create and execute a Hedera TransferTransaction
    return {
        success: true,
        transactionHash: "0.0.987654321"
    };
}

async function transferNFTToUser(nftType, serialNumber, userWallet, transactionHash) {
    // Implement NFT transfer logic
    console.log(`Transferring ${nftType}#${serialNumber} to ${userWallet}`);
    
    // This should actually create and execute a Hedera TokenAssociateTransaction and TransferTransaction
    return { success: true };
}

// Optional: Add event listener for all buy buttons
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.buy-button').forEach(button => {
        button.addEventListener('click', function() {
            const nftType = this.getAttribute('data-nft-type');
            const serialNumber = this.getAttribute('data-serial');
            buyNFT(nftType, parseInt(serialNumber));
        });
    });
});
</script>

<script>
// Handle ticket purchase buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add click event to all buy-ticket buttons
    document.querySelectorAll('.buy-ticket').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const competitionId = this.getAttribute('data-competition-id');
            const competitionTitle = this.getAttribute('data-competition-title');
            
            console.log('Buy ticket clicked for:', competitionTitle, 'ID:', competitionId);
            
            // Call the purchase function
            purchaseTicket(competitionId, competitionTitle, this);
        });
    });
});

// Purchase ticket function
async function purchaseTicket(competitionId, competitionTitle, buttonElement) {
    console.log('Starting purchase for competition:', competitionTitle);
    
    // Show loading state
    const originalText = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Processing...';
    buttonElement.disabled = true;
    
    try {
        // Check if user is logged in
        const isAuthenticated = await checkUserAuthentication();
        
        if (!isAuthenticated) {
            // Redirect to login or show login modal
            showLoginModal(competitionId);
            return;
        }
        
        // Show ticket selection modal
        showTicketSelectionModal(competitionId, competitionTitle);
        
    } catch (error) {
        console.error('Purchase error:', error);
        
        // Show error message
        showMessage('error', 'Purchase failed: ' + error.message);
        
        // Reset button
        buttonElement.innerHTML = originalText;
        buttonElement.disabled = false;
    }
}

// Check if user is authenticated (mock function - replace with actual auth check)
async function checkUserAuthentication() {
    // Replace this with your actual authentication check
    // Example: Check if user has wallet connected or is logged in
    return true; // Change to false to test login redirect
}

// Show ticket selection modal
function showTicketSelectionModal(competitionId, competitionTitle) {
    console.log('Showing ticket modal for:', competitionTitle);
    
    // Create or show modal
    const modalHtml = `
        <div id="ticketModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75">
            <div class="card-glass rounded-2xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold accent-text">Choose Your Pass</h3>
                        <button onclick="closeTicketModal()" class="text-[#9fb4c9] hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h4 class="font-semibold mb-2">${competitionTitle}</h4>
                        <p class="text-sm text-[#9fb4c9]">Select your experience pass tier</p>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="ticket-tier card-glass p-4 rounded-lg cursor-pointer border-2 border-transparent hover:border-[#00f0d6] transition-all" data-tier="REG">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold">Regular Pass</h4>
                                    <p class="text-xs text-[#9fb4c9]">General Access â€¢ 1 Vote</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold accent-text">0.8 HBAR</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ticket-tier card-glass p-4 rounded-lg cursor-pointer border-2 border-transparent hover:border-[#00f0d6] transition-all" data-tier="VIP">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold">VIP Pass</h4>
                                    <p class="text-xs text-[#9fb4c9]">Priority Access â€¢ 2 Votes</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold accent-text">1.5 HBAR</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ticket-tier card-glass p-4 rounded-lg cursor-pointer border-2 border-transparent hover:border-[#00f0d6] transition-all" data-tier="VVIP">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h4 class="font-semibold">Elite Pass</h4>
                                    <p class="text-xs text-[#9fb4c9]">VIP Access â€¢ 3 Votes</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold accent-text">3.0 HBAR</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="confirmPurchase" class="btn-primary w-full py-3 rounded-lg font-semibold" disabled>
                        Select a Pass Tier
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('ticketModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Add event listeners to ticket tiers
    document.querySelectorAll('.ticket-tier').forEach(tier => {
        tier.addEventListener('click', function() {
            // Remove selection from all tiers
            document.querySelectorAll('.ticket-tier').forEach(t => {
                t.classList.remove('border-[#00f0d6]', 'bg-[#00f0d6]/10');
            });
            
            // Add selection to clicked tier
            this.classList.add('border-[#00f0d6]', 'bg-[#00f0d6]/10');
            
            // Enable confirm button
            const confirmBtn = document.getElementById('confirmPurchase');
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = `Buy ${this.querySelector('h4').textContent} - ${this.querySelector('.accent-text').textContent}`;
            confirmBtn.setAttribute('data-tier', this.getAttribute('data-tier'));
        });
    });
    
    // Add event listener to confirm button
    document.getElementById('confirmPurchase').addEventListener('click', function() {
        const selectedTier = this.getAttribute('data-tier');
        if (selectedTier) {
            processTicketPurchase(competitionId, selectedTier);
        }
    });
}

// Process the actual ticket purchase
async function processTicketPurchase(competitionId, tier) {
    console.log('Processing purchase for competition:', competitionId, 'Tier:', tier);
    
    const confirmBtn = document.getElementById('confirmPurchase');
    const originalText = confirmBtn.innerHTML;
    
    try {
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Purchasing...';
        confirmBtn.disabled = true;
        
        // Get CSRF token for Django
        const csrfToken = getCSRFToken();
        
        // Make API call to purchase ticket
        const response = await fetch(`/arena/buy-ticket/${tier}/${competitionId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        });
        
        // Check if response is OK
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parse JSON response
        const result = await response.json();
        
        if (result.success) {
            showMessage('success', 'ðŸŽ‰ Pass purchased successfully!');
            closeTicketModal();
            
            // Show transaction details if available
            if (result.transaction_hash) {
                showMessage('info', `Transaction: ${result.transaction_hash}`);
            }
            
            // Refresh the page or update UI
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            throw new Error(result.message || 'Purchase failed');
        }
        
    } catch (error) {
        console.error('Purchase error:', error);
        
        // Handle specific error cases
        if (error.message.includes('401') || error.message.includes('403')) {
            showMessage('error', 'Please log in to purchase tickets');
            setTimeout(() => {
                window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
            }, 2000);
        } else if (error.message.includes('404')) {
            showMessage('error', 'Ticket not available or competition not found');
        } else {
            showMessage('error', error.message);
        }
        
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

// Helper function to get CSRF token
function getCSRFToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    
    if (!cookieValue) {
        console.warn('CSRF token not found');
        return '';
    }
    
    return cookieValue;
}

// Alternative CSRF token getter using Django's template tag
function getCSRFTokenFromMeta() {
    const metaTag = document.querySelector('meta[name="csrf-token"]');
    return metaTag ? metaTag.getAttribute('content') : '';
}

// Mock API function - replace with actual API call
async function mockPurchaseAPI(competitionId, tier) {
    return new Promise((resolve) => {
        setTimeout(() => {
            // Simulate random success/failure
            const success = Math.random() > 0.2; // 80% success rate
            if (success) {
                resolve({
                    success: true,
                    message: 'Ticket purchased successfully',
                    transactionHash: '0x' + Math.random().toString(16).substr(2, 64)
                });
            } else {
                resolve({
                    success: false,
                    message: 'Insufficient funds or network error'
                });
            }
        }, 1500);
    });
}

// Close ticket modal
function closeTicketModal() {
    const modal = document.getElementById('ticketModal');
    if (modal) {
        modal.remove();
    }
}

// Show login modal (simplified version)
function showLoginModal(competitionId) {
    if (confirm('You need to log in to purchase tickets. Redirect to login page?')) {
        window.location.href = `/login?next=/competition/${competitionId}/`;
    }
}

// Show message function
function showMessage(type, message) {
    // You can use your existing message system or create a simple alert
    const alertClass = type === 'success' ? 'bg-green-500' : 'bg-red-500';
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `fixed top-4 right-4 z-50 ${alertClass} text-white p-4 rounded-lg shadow-lg`;
    messageDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'} mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(messageDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentElement) {
            messageDiv.remove();
        }
    }, 5000);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.id === 'ticketModal') {
        closeTicketModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeTicketModal();
    }
});
</script>

<script>
// Competition details data (you can fetch this from your backend)
const competitionDetails = {
    {% for competition in competitions %}
    {{ competition.id }}: {
        title: "{{ competition.title|escapejs }}",
        description: "{{ competition.description|escapejs }}",
        venue: "{{ competition.venue|escapejs }}",
        date: "{{ competition.date_time|date:'M d, Y â€¢ g:i A' }}",
        category: "{{ competition.get_category_display|escapejs }}",
        status: "{{ competition.get_status_display|escapejs }}",
        prize_pool: "{{ competition.prize_pool }}",
        registration_fee: "{{ competition.registration_fee }}",
        contestants_count: {{ competition.contestant_set.count }},
        organizer: "{{ competition.organizer.user.username|escapejs }}"
    },
    {% endfor %}
};

// Show competition details modal
function showCompetitionDetails(competitionId) {
    console.log('Showing details for competition ID:', competitionId);
    
    const competition = competitionDetails[competitionId];
    
    if (!competition) {
        alert('Competition details not found!');
        return;
    }
    
    // Create modal HTML
    const modalHtml = `
        <div id="competitionDetailsModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75">
            <div class="card-glass rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-bold accent-text">${competition.title}</h3>
                        <button onclick="closeModal('competitionDetailsModal')" class="text-[#9fb4c9] hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Competition Image/Header -->
                        <div class="h-48 bg-gradient-to-br ${getCompetitionGradient(competition.category)} rounded-lg flex items-center justify-center">
                            <i class="fas ${getCompetitionIcon(competition.category)} text-white text-5xl"></i>
                        </div>
                        
                        <!-- Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Venue</p>
                                <p class="font-semibold">${competition.venue}</p>
                            </div>
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Date & Time</p>
                                <p class="font-semibold">${competition.date}</p>
                            </div>
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Prize Pool</p>
                                <p class="font-semibold accent-text">$${competition.prize_pool} HTS</p>
                            </div>
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Contestants</p>
                                <p class="font-semibold">${competition.contestants_count} Registered</p>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="bg-[#071026] p-4 rounded-lg">
                            <h4 class="font-semibold mb-2">About this Competition</h4>
                            <p class="text-[#9fb4c9] text-sm">${competition.description}</p>
                        </div>
                        
                        <!-- Additional Info -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Category</p>
                                <p class="font-semibold">${competition.category}</p>
                            </div>
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Status</p>
                                <p class="font-semibold">${competition.status}</p>
                            </div>
                            <div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Registration Fee</p>
                                <p class="font-semibold">$${competition.registration_fee} HTS</p>
                            </div>
                            <!--div class="bg-[#071026] p-3 rounded-lg">
                                <p class="text-sm text-[#9fb4c9]">Organizer</p>
                                <p class="font-semibold">${competition.organizer}</p>
                            </div-->
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <!--div class="flex gap-3 mt-6">
                        <button onclick="showRegistrationModal(${competitionId})" class="btn-primary flex-1 py-3">
                            <i class="fas fa-user-plus mr-2"></i>Register as Competitor
                        </button>
                        <button onclick="showTicketModal(${competitionId})" class="btn-secondary flex-1 py-3">
                            <i class="fas fa-ticket-alt mr-2"></i>Buy Experience Pass
                        </button>
                    </div-->
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('competitionDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Helper functions for gradients and icons
function getCompetitionGradient(category) {
    const gradients = {
        'Music': 'from-[#00f0d6] to-[#007a6c]',
        'Dance': 'from-[#9d4edd] to-[#5a189a]',
        'Comedy': 'from-[#ff6b6b] to-[#c0392b]',
        'Poetry': 'from-[#4cc9f0] to-[#4895ef]',
        'Martial Arts': 'from-[#f9c74f] to-[#f9844a]',
    };
    return gradients[category] || 'from-[#4cc9f0] to-[#4895ef]';
}

function getCompetitionIcon(category) {
    const icons = {
        'Music': 'fa-microphone-alt',
        'Dance': 'fa-music',
        'Comedy': 'fa-theater-masks',
        'Poetry': 'fa-feather-alt',
        'Martial Arts': 'fa-fist-raised',
    };
    return icons[category] || 'fa-ticket-alt';
}

// Close modal function
function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.remove();
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    if (event.target.id === 'competitionDetailsModal') {
        closeModal('competitionDetailsModal');
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal('competitionDetailsModal');
    }
});

// Placeholder functions for other modals (you'll need to implement these)
function showRegistrationModal(competitionId) {
    alert('Registration modal would open for competition: ' + competitionId);
    // Implement your registration modal logic here
}

function showTicketModal(competitionId) {
    alert('Ticket modal would open for competition: ' + competitionId);
    // Implement your ticket purchase modal logic here
}
</script>
{% endblock content %}